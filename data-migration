
#如何做好一次用户无感知的业务数据迁移

## 容量评估

根据现有数据量、新数据格式以及未来 6 个月的数据增长，很容易评估需要的存储容量。

可以按150%的容量来准备存储机器。

## 迁移脚本

需要编写：数据迁移脚本、数据校验脚本

## 业务代码改动

需要业务代码做一些旁路双写的工作

做完以上准备工作，就可以进行数据迁移了，步骤如下：

- 1、旁路写一份数据到新的存储；
- 2、通过数据迁移脚步，批量导入数据到新存储；（该步骤一般在业务低峰期执行，避免影响线上服务）
- 3、对比新、老存储数据一致性，并修复差异数据，直到数据完全一致；
- 4、切读到新存储，观察新存储可用性指标；（该步骤一般灰度进行）
- 5、移除对老存储的双写；（该步骤可以观察一周后再执行）

## 遇到过坑

- 1、数据校验一直无法到达完全一致，这里需要先检查双写逻辑，避免某些地方遗漏双写；
- 2、新存储故障导致不可用，切读到新存储时，需要灰度观察一段时间，同时需要观察存储可用性指标；

